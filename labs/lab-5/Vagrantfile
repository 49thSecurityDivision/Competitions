# -*- mode: ruby -*-
# vi: set ft=ruby :

Vagrant.configure("2") do |config|

  config.vm.define "ubuntu_vm" do |ubuntu|
    config.vm.box = "ubuntu/bionic64"
    config.vm.boot_timeout = 120

    config.vm.provision "shell", inline: <<-SHELL
      # Update and Install Services
      apt-get update
      apt-get install -y apache2 mysql-server redis-server mongodb nginx ftp vsftpd telnetd rsh-server postfix

      # 1. Apache2: Enable directory listing and put server version on pages
      a2dismod -f autoindex
      sed -i 's/ServerTokens OS/ServerTokens Prod/' /etc/apache2/apache2.conf

      # 2. MySQL: Allow remote root login without password
      mysql -e "GRANT ALL PRIVILEGES ON *.* TO 'root'@'%' IDENTIFIED BY '' WITH GRANT OPTION; FLUSH PRIVILEGES;"

      # 3. Redis: Bind to all interfaces with no password
      sed -i 's/bind 127.0.0.1/bind 0.0.0.0/' /etc/redis/redis.conf
      sed -i 's/# requirepass foobared/requirepass ""/' /etc/redis/redis.conf

      # 4. MongoDB: No authentication and bind to all interfaces
      sed -i 's/bindIp: 127.0.0.1/bindIp: 0.0.0.0/' /etc/mongod.conf

      # 5. Nginx: Server tokens on
      sed -i 's/server_tokens off;/server_tokens on;/' /etc/nginx/nginx.conf

      # 6. FTP: Anonymous login enabled
      echo "anonymous_enable=YES" >> /etc/vsftpd.conf

      # 7. VSFTPD: Enable write access for anonymous
      echo "anon_upload_enable=YES" >> /etc/vsftpd.conf
      echo "anon_mkdir_write_enable=YES" >> /etc/vsftpd.conf

      # 8. Telnet: Enable the telnet service
      systemctl enable telnetd

      # 9. RSH: Enable the rsh service
      systemctl enable rsh-server

      # 10. Postfix: Open relay configuration
      postconf -e "relayhost = "
      postconf -e "mynetworks = 0.0.0.0/0"
      postconf -e "smtpd_relay_restrictions = permit_mynetworks permit_sasl_authenticated defer_unauth_destination"

      # Restart all services to apply changes
      systemctl restart apache2 mysql redis-server mongod nginx vsftpd telnetd rsh-server postfix
    SHELL
  end

  config.vm.define "windows_server" do |windows|
    windows.vm.box = "gusztavvargadr/windows-server"
    windows.vm.box_version = "2102.0.2310"

    # Forwarding ports for services
    windows.vm.network "forwarded_port", guest: 80, host: 8080
    windows.vm.network "forwarded_port", guest: 3306, host: 3307
    windows.vm.network "forwarded_port", guest: 21, host: 2121

    # Windows provision script
    windows.vm.provision "shell", inline: <<-POWERSHELL
      Install-WindowsFeature -Name Web-Server, Web-Mgmt-Tools
      Install-WindowsFeature -Name FTP-Server
      Install-WindowsFeature -Name Telnet-Server

      # Misconfigured IIS
      Import-Module WebAdministration
      Set-WebConfigurationProperty -filter /system.webServer/security/authentication/anonymousAuthentication -name enabled -value True -PSPath 'IIS:/'

      windows.vm.provision "file", source: "./scripts/ftp.ps1", destination: "C:\\ftp.ps1"
      windows.vm.provision "shell", path: "ftp.ps1"

      windows.vm.provision "file", source: "./setup_mysql.ps1", destination: "C:\\mysql.ps1"
      windows.vm.provision "shell", path: "mysql.ps1"

      # Misconfigure Windows Firewall (similar to having no firewall on Ubuntu)
      Set-NetFirewallProfile -Profile Domain,Public,Private -Enabled False

      # Restart services to apply changes
      Restart-Service -Name W3SVC
      Restart-Service -Name FTPsvc
    POWERSHELL
  end
end
